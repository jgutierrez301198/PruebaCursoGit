$Conn = Get-AutomationConnection -Name AzureRunAsConnection
Add-AzAccount -ServicePrincipal -Tenant $Conn.Tenantid -ApplicationId $Conn.ApplicationID -CertificateThumbprint $Conn.CertificateThumbprint
Select-AzSubscription -SubscriptionId 4b4457fb-2ae0-4781-ab15-b6c215eb9e86
$rgName = 'RG-QA';
$nsgname = 'SGN-QA';
$Domain = 'services.pagoefectivo.pe'
$Uri = 'https://dns.google.com/resolve?name={0}' -f $Domain
$ipRange = (Invoke-RestMethod -Uri $URI).Answer.data -replace '^\d+\s'
$ipRange
$rulePriority = 100
$rulePriority2 = 200
$ruleNameOut = "HTTPS"
$ruleNameOutHTTP = "HTTP"
$nsg = Get-AzNetworkSecurityGroup -Name $nsgname -ResourceGroupName $rgName -ErrorAction:Stop;
Write-Host "Applying AzureCloud Ip addresses to non production NSG  $nsgname..."
$outbountRule = ($nsg | Get-AzNetworkSecurityRuleConfig -Name $ruleNameOut -ErrorAction SilentlyContinue)
if($outbountRule -eq $null)
{
    $nsg | Add-AzNetworkSecurityRuleConfig -Name $ruleNameOut -Description "Allow outbound to Azure data centers" -Access Allow -Protocol TCP -Direction Outbound -Priority $rulePriority -SourceAddressPrefix 10.105.0.10 -SourcePortRange * -DestinationAddressPrefix $ipRange -DestinationPortRange 443 -ErrorAction:Stop | Set-AzNetworkSecurityGroup -ErrorAction:Stop | Out-NULL;
    Write-Host "Created NSG rule $ruleNameOut for $nsgname"
}
else {
    $nsg | Set-AzNetworkSecurityRuleConfig -Name $ruleNameOut -Description "PAGOEFECTIVO" -Access Allow -Protocol TCP -Direction Outbound -Priority $rulePriority -SourceAddressPrefix 10.105.0.10 -SourcePortRange * -DestinationAddressPrefix $ipRange -DestinationPortRange 443 -ErrorAction:Stop | Set-AzNetworkSecurityGroup -ErrorAction:Stop | Out-NULL;
    Write-Host "Updated NSG rule $ruleNameOut for $nsgname"
}

$outbountRule2 = ($nsg | Get-AzNetworkSecurityRuleConfig -Name $ruleNameOutHTTP -ErrorAction SilentlyContinue)
if($outbountRule2 -eq $null)
{
    $nsg | Add-AzNetworkSecurityRuleConfig -Name $ruleNameOutHTTP -Description "Allow outbound to Azure data centers" -Access Allow -Protocol TCP -Direction Outbound -Priority $rulePriority2 -SourceAddressPrefix 10.105.0.10 -SourcePortRange * -DestinationAddressPrefix $ipRange -DestinationPortRange 80 -ErrorAction:Stop | Set-AzNetworkSecurityGroup -ErrorAction:Stop | Out-NULL;
    Write-Host "Created NSG rule $ruleNameOutHTTP for $nsgname"
}
else {
    $nsg | Set-AzNetworkSecurityRuleConfig -Name $ruleNameOutHTTP -Description "PAGOEFECTIVO" -Access Allow -Protocol TCP -Direction Outbound -Priority $rulePriority2 -SourceAddressPrefix 10.105.0.10 -SourcePortRange * -DestinationAddressPrefix $ipRange -DestinationPortRange 80 -ErrorAction:Stop | Set-AzNetworkSecurityGroup -ErrorAction:Stop | Out-NULL;
    Write-Host "Updated NSG rule $ruleNameOutHTTP for $nsgname"
}